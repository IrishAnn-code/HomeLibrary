{% extends "base.html" %}

{% block crud_container %}
<article class="card container fluid">
    <div class="d-flex bd-highlight mb-0">
        <div class="me-auto p-3 bd-highlight fs-4">{{ book.author }}: {{ book.title }}</div>

            <div class="d-flex gap-2 align-items-center">
               {% if permissions.can_edit_status %}
                <a href="/book/{{ book.id }}/edit" class="btn btn-outline-secondary d-flex align-items-center" >‚úèÔ∏è</a>
               {% endif %}

               {% if permissions.can_delete %}
                <button type="button" class="btn btn-outline-danger"
                    onclick="confirmDelete({{ book.id }}, '{{ book.title }}', '{{ book.author }}')">üóë</button>
               {% endif %}
            </div>
    </div>

    <div class="row">
        <!-- –õ–µ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü -->
        <div class="col-12 col-md-6 mb-3">
            <div class="card">
                <div class="card-body pb-0">
                    <h5 class="card-title ms-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–Ω–∏–≥–µ</h5>
                    <table class="table table-responsive mb-0">
                        <tr>
                            <td class="fw-bold" style="width: 40%;">–°—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è:</td>
                            <td>{{ read_status }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">–ñ–∞–Ω—Ä:</td>
                            <td>{{ book.genre }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">–û–ø–∏—Å–∞–Ω–∏–µ:</td>
                            <td>{{ book.description or "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è" }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">–¶–≤–µ—Ç –æ–±–ª–æ–∂–∫–∏:</td>
                            <td><div class="book-color">
                                <span class="color-visual" style="background-color: {{ book.color }};"></span>
                            </div></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü -->
        <div class="col-12 col-md-6 mb-3">
            <div class="card">
                <div class="card-body pb-0">
                    <h5 class="card-title ms-2">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</h5>
                    <table class="table table-responsive mb-0">
                        <tr>
                            <td class="fw-bold">–ì–¥–µ –∫–Ω–∏–≥–∞ —Å–µ–π—á–∞—Å:</td>
                            <td>{{ '–í –±–∏–±–ª–∏–æ—Ç–µ–∫–µ' if book.location == book.lib_address else (book.location if book.location else '–í –±–∏–±–ª–∏–æ—Ç–µ–∫–µ')  }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold" style="width: 40%;">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞:</td>
                            <td>{{ book.lib_address }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">–ö–æ–º–Ω–∞—Ç–∞:</td>
                            <td>{{ book.room or "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è" }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">–ü–æ–ª–∫–∞:</td>
                            <td>{{ book.shelf or "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è" }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">–î–æ–±–∞–≤–ª–µ–Ω–∞:</td>
                            <td>{{ user.username }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- –ë–ª–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->

<div class="mt-4">
    <div class="card-body">
        <h5 class="card-title">üí¨ –û—Ç–∑—ã–≤—ã –æ –∫–Ω–∏–≥–µ ({{ comments|length }})</h5>

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        <form action="/book/{{ book.id }}/comments" method="post" class="mb-4">
            <div class="input-group">
                <textarea name="message" class="form-control" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤..."
                         rows="2" required></textarea>
                <button type="submit" class="btn btn-success">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </form>

        <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <div class="comments-list">
            {% for comment in comments %}
            <div class="card mb-2 {% if comment.user_id == current_user.id %}border-black-50{% endif %}">
                <div class="card-body py-0">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <strong class="text-dark">{{ comment.user.username }}</strong>
                            <small class="text-muted ms-2"> {{ (comment.created_at|utc_to_local).strftime('%d.%m.%Y %H:%M') }} </small>
                            <p class="mb-0 mt-1">{{ comment.message }}</p>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤) -->
                        {% if comment.user_id == current_user.id %}
                        <div class="btn-group btn-group-sm ms-2">
                            <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                            <button type="button" class="btn btn-outline-warning btn-sm"
                                    data-bs-toggle="modal" data-bs-target="#editCommentModal"
                                    onclick="setEditComment({{ comment.id }}, `{{ comment.message | replace('`', '\\`') }}`)">
                                ‚úèÔ∏è
                            </button>
                            <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                            <button type="button" class="btn btn-outline-danger btn-sm"
                                    data-bs-toggle="modal" data-bs-target="#deleteCommentModal"
                                    onclick="setDeleteComment({{ comment.id }})">
                                üóë
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center text-muted py-3">
                –ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
<div class="modal fade" id="editCommentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCommentForm" method="post">
                <div class="modal-body">
                    <textarea name="message" class="form-control" rows="3" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-warning">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
<div class="modal fade" id="deleteCommentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <form id="deleteCommentForm" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                </form>
            </div>
        </div>
    </div>
</div>
    <br>

<script>
function setEditComment(commentId, currentText) {
    document.getElementById('editCommentForm').action = `/book/comments/${commentId}/edit`;
    document.querySelector('#editCommentForm textarea[name="message"]').value = currentText;
}

function setDeleteComment(commentId) {
    document.getElementById('deleteCommentForm').action = `/book/comments/${commentId}/delete`;
}
</script>

</article>

<!-- ‚úÖ Modal –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
{% if permissions.can_delete %}
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title text-dark w-100">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-dark">
          <div class="alert alert-danger py-2">
                <div class="text-center fw-bold mb-1">–≠–¢–û –î–ï–ô–°–¢–í–ò–ï –ù–ï–õ–¨–ó–Ø –û–¢–ú–ï–ù–ò–¢–¨</div>
                <div class="text-center">
                  –í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É?
                  <div class="mt-2 p-2 bg-light rounded border">
                          <strong id="book-full-info" class="text-danger">–ê–≤—Ç–æ—Ä: ¬´–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏¬ª</strong>
                  </div>
                </div>
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <form id="deleteForm" method="post" style="display:inline;">
          <button type="submit" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<style>
.book-color {
  display: flex;
  align-items: center;
  gap: 8px;
}

.color-visual {
  width: 25px;
  height: 25px;
  border-radius: 10px;
  border: 1px solid #dee2e6;
  display: inline-block;
}

/* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–¥ */
@media (max-width: 768px) {
  .color-code {
    display: none;
  }
}
</style>

<script>
function confirmDelete(bookId, bookTitle, bookAuthor = null) {
  //–§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å –∞–≤—Ç–æ—Ä–æ–º –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–Ω–∏–≥–∏
  const displayText = bookAuthor ? `${bookAuthor}: ¬´${bookTitle}¬ª` : `¬´${bookTitle}¬ª`;

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
  document.getElementById('book-full-info').textContent = displayText;

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º action —Ñ–æ—Ä–º—ã
  document.getElementById('deleteForm').action = `/book/${bookId}/delete`;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º modal
  const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
  modal.show();
}
</script>

{% endblock %}